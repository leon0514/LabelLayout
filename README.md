# LabelLayoutSolver

**LabelLayoutSolver** æ˜¯ä¸€ä¸ªè½»é‡çº§ã€æ— ä¾èµ–ï¼ˆHeader-onlyï¼‰çš„ C++ æ ‡ç­¾å¸ƒå±€æ±‚è§£å™¨ã€‚å®ƒä¸“é—¨ç”¨äºè§£å†³ 2D ç»˜å›¾åœºæ™¯ä¸­ï¼ˆå¦‚ç›®æ ‡æ£€æµ‹æ ‡æ³¨ã€å›¾è¡¨æ ‡æ³¨ã€æ¸¸æˆ UIï¼‰æ–‡å­—æ ‡ç­¾ä¸ç‰©ä½“ä¹‹é—´ã€æ ‡ç­¾ä¸æ ‡ç­¾ä¹‹é—´çš„é‡å é—®é¢˜ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

*   **é›¶ä¾èµ–**ï¼šå•å¤´æ–‡ä»¶ (`.hpp`)ï¼Œç›´æ¥åŒ…å«å³å¯ä½¿ç”¨ï¼Œä¸ä¾èµ– OpenCVã€Qt æˆ– boostã€‚
*   **æ™ºèƒ½é¿è®©**ï¼šè‡ªåŠ¨è®¡ç®—æ ‡ç­¾ä½ç½®ï¼Œé˜²æ­¢æ ‡ç­¾ç›¸äº’é®æŒ¡ï¼ŒåŒæ—¶å°½é‡ä¸é®æŒ¡è¢«æ ‡æ³¨çš„ç›®æ ‡ç‰©ä½“ã€‚
*   **åŠ¨æ€ç¼©æ”¾**ï¼šå½“ç©ºé—´æå…¶æ‹¥æŒ¤æ—¶ï¼Œæ”¯æŒè‡ªåŠ¨ç¼©å°å­—å·ä»¥é€‚é…å¸ƒå±€ï¼ˆå¤šçº§å­—ä½“å¤§å°å°è¯•ï¼‰ã€‚
*   **é«˜æ€§èƒ½**ï¼šå†…ç½® **Uniform Gridï¼ˆå‡åŒ€ç½‘æ ¼ï¼‰** ç©ºé—´ç´¢å¼•ï¼Œåœ¨å¤§é‡æ ‡ç­¾ï¼ˆæ•°ç™¾ä¸ªï¼‰åœºæ™¯ä¸‹ä»èƒ½ä¿æŒæé«˜çš„æ±‚è§£é€Ÿåº¦ã€‚
*   **é«˜åº¦å¯å®šåˆ¶**ï¼šæ”¯æŒè‡ªå®šä¹‰å­—ä½“æµ‹é‡å›è°ƒå‡½æ•°ï¼Œå¯è½»æ¾å¯¹æ¥ FreeType, GDI+, Qt, OpenCV, ImGui ç­‰æ¸²æŸ“åç«¯ã€‚

---

## ğŸ§  æ ¸å¿ƒåŸç† (Algorithm)

è¯¥æ±‚è§£å™¨ä¸ä½¿ç”¨å¤æ‚çš„ç‰©ç†å¼•æ“æˆ–é—ä¼ ç®—æ³•ï¼Œè€Œæ˜¯é‡‡ç”¨äº†ä¸€ç§é«˜æ•ˆçš„ **ç¦»æ•£åŒ–å€™é€‰ç‚¹è¯„ä¼° + è´ªå¿ƒè¿­ä»£ç­–ç•¥**ã€‚

### 1. å€™é€‰ä½ç½®ç”Ÿæˆ (Candidate Generation)
å¯¹äºæ¯ä¸€ä¸ªè¢«æ ‡æ³¨ç‰©ä½“ï¼Œç®—æ³•ä¼šå›´ç»•å…¶è¾¹ç•Œï¼ˆä¸Šã€ä¸‹ã€å·¦ã€å³ï¼‰ä»¥åŠå†…éƒ¨ç”Ÿæˆæ•°åä¸ªæ½œåœ¨çš„æ ‡ç­¾æ”¾ç½®ä½ç½®ï¼ˆCandidatesï¼‰ã€‚
*   **ä½ç½®åå¥½**ï¼šé¢„è®¾äº†ä½ç½®ä¼˜å…ˆçº§ï¼Œä¾‹å¦‚ï¼š`å·¦ä¸Šå¤–ä¾§` > `å·¦ä¸Šå†…ä¾§` > `å³ä¸‹å¤–ä¾§` ç­‰ã€‚
*   **æ»‘åŠ¨çª—å£**ï¼šåœ¨æ¯ä¸€æ¡è¾¹ä¸Šï¼Œæ ‡ç­¾ä¼šå°è¯•æ²¿è¾¹ç¼˜æ»‘åŠ¨ï¼Œç”Ÿæˆå¤šä¸ªå€™é€‰åæ ‡ã€‚
*   **å¤šçº§ç¼©æ”¾**ï¼šé™¤äº†åŸºå‡†å­—å·ï¼ˆ1.0xï¼‰ï¼Œè¿˜ä¼šç”Ÿæˆ 0.9x, 0.8x ... 0.5x çš„å€™é€‰æ¡†ã€‚ä¸ºäº†ä¿è¯å¯è¯»æ€§ï¼Œç®—æ³•ç»™äºˆç¼©æ”¾æå¤§çš„æƒ©ç½šæƒé‡ï¼ˆåªæœ‰åœ¨ä¸ç¼©æ”¾å°±ä¸€å®šé‡å æ—¶æ‰ä¼šé€‰æ‹©ç¼©æ”¾ï¼‰ã€‚

### 2. ä»£ä»·å‡½æ•° (Cost Function)
æ¯ä¸ªå€™é€‰ä½ç½®éƒ½æœ‰ä¸€ä¸ª `TotalCost`ï¼Œè¶Šå°è¶Šå¥½ï¼š

$$ TotalCost = BaseCost + ScalePenalty + OcclusionCost + OverlapCost $$

*   **BaseCost**ï¼šä½ç½®åå¥½ï¼ˆä¾‹å¦‚æ”¾åœ¨å·¦ä¸Šè§’æ¯”æ”¾åœ¨ä¸­é—´å¥½ï¼‰ã€‚
*   **ScalePenalty**ï¼šå­—ä½“ç¼©å°çš„æƒ©ç½šï¼ˆé˜¶æ¢¯å¼æƒ©ç½šï¼Œå¼ºçƒˆå€¾å‘äºä¿æŒåŸå­—å·ï¼‰ã€‚
*   **OcclusionCost**ï¼šé®æŒ¡ç‰©ä½“æœ¬èº«çš„æƒ©ç½šï¼ˆå°½é‡ä¸ç›–ä½ç‰©ä½“ï¼‰ã€‚
*   **OverlapCost**ï¼šä¸å…¶ä»–æ ‡ç­¾é‡å çš„æƒ©ç½šï¼ˆè¿™æ˜¯è‡´å‘½æƒ©ç½šï¼Œæƒé‡æå¤§ï¼‰ã€‚

### 3. ç©ºé—´ç´¢å¼• (Spatial Indexing)
ä¸ºäº†é¿å… $O(N^2)$ çš„ä¸¤ä¸¤ç¢°æ’æ£€æµ‹ï¼Œå†…éƒ¨å®ç°äº†ä¸€ä¸ª `UniformGrid`ã€‚
*   å°†ç”»å¸ƒåˆ’åˆ†ä¸º $100 \times 100$ çš„ç½‘æ ¼ã€‚
*   æŸ¥è¯¢æŸä¸ªåŒºåŸŸæ˜¯å¦è¢«å ç”¨åªéœ€æ£€æŸ¥å¯¹åº”çš„å‡ ä¸ªç½‘æ ¼å•å…ƒï¼Œæå¤§åœ°åŠ é€Ÿäº†å†²çªæ£€æµ‹ã€‚

### 4. è¿­ä»£æ±‚è§£ (Iterative Solver)
1.  **é™æ€åˆå§‹åŒ–**ï¼šé¦–å…ˆæ ¹æ®ä½ç½®åå¥½å’Œç‰©ä½“é®æŒ¡æƒ…å†µï¼Œä¸ºæ¯ä¸ªç‰©ä½“é€‰æ‹©ä¸€ä¸ªâ€œå½“å‰æœ€ä½³â€å€™é€‰ä½ç½®ã€‚
2.  **å†²çªæ¶ˆè§£å¾ªç¯**ï¼š
    *   æ„å»ºå½“å‰æ‰€æœ‰é€‰ä¸­æ ‡ç­¾çš„ç©ºé—´ç½‘æ ¼ã€‚
    *   éå†æ¯ä¸ªæ ‡ç­¾ï¼Œæ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–æ ‡ç­¾é‡å ã€‚
    *   å¦‚æœå‘ç”Ÿé‡å ï¼Œé‡æ–°è¯„ä¼°è¯¥ç‰©ä½“çš„æ‰€æœ‰å€™é€‰ä½ç½®ï¼Œå¯»æ‰¾ä¸€ä¸ªé€šè¿‡ grid æŸ¥è¯¢ç¡®è®¤ä¸é‡å ä¸”ä»£ä»·æœ€å°çš„æ–°ä½ç½®ã€‚
    *   é‡å¤æ­¤è¿‡ç¨‹ç›´åˆ°æ— å†²çªæˆ–è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ã€‚

---

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹ (Usage)

### 1. å¼•å…¥å¤´æ–‡ä»¶
å°† `LabelLayoutSolver.hpp` å¤åˆ¶åˆ°ä½ çš„é¡¹ç›®ä¸­å¹¶åŒ…å«ï¼š

```cpp
#include "LabelLayoutSolver.hpp"
```

### 2. å®šä¹‰å­—ä½“æµ‹é‡å‡½æ•°
æ±‚è§£å™¨éœ€è¦çŸ¥é“æ–‡å­—åœ¨ä¸åŒå­—å·ä¸‹çš„å®é™…å®½é«˜ã€‚ä½ éœ€è¦æä¾›ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼ˆLambda æˆ–å‡½æ•°æŒ‡é’ˆï¼‰ã€‚

> **æ³¨æ„**ï¼šè¿™é‡Œçš„æµ‹é‡é€»è¾‘åº”ä¸ä½ å®é™…ç»˜å›¾ä½¿ç”¨çš„åº“ä¸€è‡´ï¼ˆå¦‚ `cv::getTextSize`, `QFontMetrics`, `ImGui::CalcTextSize` ç­‰ï¼‰ã€‚

```cpp
// ç¤ºä¾‹ï¼šä¸€ä¸ªç®€å•çš„æ¨¡æ‹Ÿæµ‹é‡å‡½æ•°
// è¿”å›ç»“æ„ï¼š{å®½åº¦, Ascent(åŸºçº¿ä»¥ä¸Šé«˜åº¦), Descent(åŸºçº¿ä»¥ä¸‹é«˜åº¦)}
auto measureFunc = [](const std::string& text, int fontSize) -> TextSize {
    // å‡è®¾æ¯ä¸ªå­—ç¬¦å®½åº¦ä¸º fontSize * 0.6ï¼Œé«˜åº¦ä¸º fontSize
    int w = static_cast<int>(text.length() * fontSize * 0.6f);
    int h = fontSize; 
    int baseline = fontSize / 4; 
    return {w, h, baseline};
};
```

### 3. åˆå§‹åŒ–ä¸æ·»åŠ æ•°æ®

```cpp
// 1. åˆ›å»ºæ±‚è§£å™¨ (ç”»å¸ƒå®½ 1920, é«˜ 1080)
LabelLayoutSolver solver(1920, 1080, measureFunc);

// 2. æ·»åŠ è¢«æ ‡æ³¨ç‰©ä½“
// å‚æ•°: left, top, right, bottom, æ ‡ç­¾æ–‡æœ¬, åŸºå‡†å­—å·
solver.add(100, 100, 200, 200, "Person: 98%", 20);
solver.add(180, 180, 300, 300, "Car: 85%", 20); // æ•…æ„åˆ¶é€ é‡å åœºæ™¯
solver.add(500, 500, 550, 550, "Small Object", 16);
```

### 4. æ±‚è§£ä¸è·å–ç»“æœ

```cpp
// 3. æ‰§è¡Œå¸ƒå±€è®¡ç®—
solver.solve();

// 4. è·å–ç»“æœ
auto results = solver.getResults();

// 5. ç»˜åˆ¶ç»“æœ
for (size_t i = 0; i < results.size(); ++i) {
    const auto& res = results[i];
    
    // res.x, res.y æ˜¯è®¡ç®—å‡ºçš„æ ‡ç­¾å·¦ä¸Šè§’åæ ‡
    // res.fontSize æ˜¯å»ºè®®ä½¿ç”¨çš„å­—å·ï¼ˆå¯èƒ½è¢«ç¼©å°ï¼‰
    printf("Label %zu: Pos(%.1f, %.1f), Size(%dx%d), Font: %d\n", 
            i, res.x, res.y, res.width, res.height, res.fontSize);
            
    // åœ¨æ­¤å¤„è°ƒç”¨ä½ çš„ç»˜å›¾å‡½æ•°ï¼Œä¾‹å¦‚ï¼š
    // drawRect(res.x, res.y, res.width, res.height);
    // drawText(text[i], res.x, res.y + res.textAscent, res.fontSize);
}
```

---

## ğŸ› ï¸ å®Œæ•´ç¤ºä¾‹ä»£ç 

è¿™æ˜¯ä¸€ä¸ªå¯ç›´æ¥ç¼–è¯‘è¿è¡Œçš„ `main.cpp` ç¤ºä¾‹ï¼š

```cpp
#include <iostream>
#include <vector>
#include "LabelLayoutSolver.hpp"

int main() {
    // 1. å®šä¹‰æµ‹é‡å‡½æ•° (è¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…è¯·å¯¹æ¥ä½ çš„ UI åº“)
    auto mockMeasure = [](const std::string& text, int fontSize) -> TextSize {
        return {
            (int)(text.length() * fontSize * 0.6), // width
            fontSize,                              // height (ascent)
            (int)(fontSize * 0.2)                  // baseline (descent)
        };
    };

    // 2. åˆå§‹åŒ–æ±‚è§£å™¨ (ç”»å¸ƒ 800x600)
    LabelLayoutSolver solver(800, 600, mockMeasure);

    // 3. æ·»åŠ ä¸€äº›é‡å çš„ç‰©ä½“
    // ç‰©ä½“ A
    solver.add(100, 100, 200, 200, "Object A", 24);
    // ç‰©ä½“ B (ç´§æŒ¨ç€ Aï¼Œä¼šå¯¼è‡´é»˜è®¤çš„å·¦ä¸Šè§’æ ‡ç­¾é‡å )
    solver.add(120, 80, 220, 180, "Object B (Conflict)", 24);
    // ç‰©ä½“ C (åœ¨è¾¹ç¼˜ï¼Œæµ‹è¯•è¾¹ç•Œæ£€æŸ¥)
    solver.add(750, 10, 790, 50, "Edge Case", 20);

    // 4. æ±‚è§£
    std::cout << "Solving layout..." << std::endl;
    solver.solve();

    // 5. è¾“å‡ºç»“æœ
    auto results = solver.getResults();
    for (size_t i = 0; i < results.size(); ++i) {
        const auto& r = results[i];
        std::cout << "Item " << i << " layout: "
                  << "X=" << r.x << ", Y=" << r.y 
                  << " [W=" << r.width << ", H=" << r.height << "]"
                  << " FontSize=" << r.fontSize 
                  << std::endl;
    }

    return 0;
}
```

## âš™ï¸ å‚æ•°è°ƒä¼˜ (Advanced)

å¦‚æœä½ éœ€è¦è°ƒæ•´å¸ƒå±€ç­–ç•¥ï¼ˆä¾‹å¦‚æ›´å–œæ¬¢æŠŠæ ‡ç­¾æ”¾åœ¨ç‰©ä½“å†…éƒ¨ï¼Œæˆ–è€…ç¦æ­¢å­—ä½“ç¼©å°ï¼‰ï¼Œå¯ä»¥åœ¨ `LabelLayoutSolver.hpp` çš„ `private` åŒºåŸŸä¿®æ”¹ä»¥ä¸‹å¸¸é‡ï¼š

*   `COST_TL_OUTER`, `COST_TR_OUTER` ç­‰ï¼šè°ƒæ•´å„ä¸ªæ–¹ä½çš„åå¥½æƒé‡ã€‚å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚
*   `COST_SCALE_TIER`ï¼šç¼©æ”¾æƒ©ç½šã€‚å¦‚æœä½ å®Œå…¨ä¸æƒ³è®©å­—ä½“ç¼©å°ï¼Œå¯ä»¥å°†æ­¤å€¼è®¾ä¸ºæ— ç©·å¤§ã€‚
*   `COST_OCCLUDE_OBJ`ï¼šé®æŒ¡ç‰©ä½“çš„ä»£ä»·ã€‚å¦‚æœä½ ä¸ä»‹æ„æ ‡ç­¾æŒ¡ä½ç‰©ä½“ï¼Œå¯å‡å°æ­¤å€¼ã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

1.  **åæ ‡ç³»**ï¼šé»˜è®¤åæ ‡ç³»åŸç‚¹ä¸ºå·¦ä¸Šè§’ (X å‘å³, Y å‘ä¸‹)ã€‚
2.  **æ€§èƒ½**ï¼šå¯¹äº < 500 ä¸ªç‰©ä½“çš„åœºæ™¯ï¼Œæ±‚è§£é€šå¸¸åœ¨æ¯«ç§’çº§å®Œæˆã€‚æå¤§é‡çº§å»ºè®®åˆ†åŒºåŸŸæ±‚è§£ã€‚
3.  **å­—ä½“æµ‹é‡**ï¼š`measureFunc` çš„å‡†ç¡®æ€§ç›´æ¥å†³å®šäº†å¸ƒå±€æ•ˆæœã€‚åŠ¡å¿…ç¡®ä¿ä¼ å…¥çš„å‡½æ•°èƒ½å‡†ç¡®åæ˜ æ¸²æŸ“æ—¶çš„æ–‡æœ¬å¤§å°ã€‚

---

### License
MIT License 
